<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="安迪兒隨手貼">
<meta name="description" content="Docker 1.12的黑魔法">

<base href="127.0.0.1/127.0.0.1/">
<title>


     安迪兒隨手貼 - Docker 1.12的黑魔法 

</title>
<link rel="canonical" href="127.0.0.1/127.0.0.1/post/20160730/">



  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">


<link rel="stylesheet" href="127.0.0.1/127.0.0.1/css/reset.css">
<link rel="stylesheet" href="127.0.0.1/127.0.0.1/css/main.css">




<link rel="shortcut icon"

    href="127.0.0.1/img/logo.png"

>



</head>


<body lang="en">


<section class="header">

    <div class="container">
        <a href="127.0.0.1/127.0.0.1/"><img class="logo" src="127.0.0.1/img/logo.png" alt="安迪兒隨手貼 Logo"/></a>
        <div class="content">
            <a href="127.0.0.1/127.0.0.1/"><div class="name"><h1>安迪兒隨手貼</h1></div></a>
            <nav>
                <ul>
                    <a href="127.0.0.1/127.0.0.1/post/"><li>Post</li></a>
                    
                        
                    
                        
                            
                        
                    
                        
                            
                            <a href="projects"><li>projects</li></a>
                            
                        
                    
                    
                        
                            <a href="127.0.0.1/127.0.0.1/about/"><li>About</li></a>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">

        
            <a href="https://github.com/bowwowxx" target="_blank">
                <i class="icon ion-social-github"></i>
            </a>
        

        
            <a href="#" target="_blank">
                <i class="icon ion-social-twitter"></i>
            </a>
        

        
            <a href="#" target="_blank">
                <i class="icon ion-social-linkedin"></i>
            </a>
        

        
            <a href="mailto:jummykimo@gmail.com">
                <i class="icon ion-ios-email larger"></i>
            </a>
        

        
            <a href="127.0.0.1/index.xml">
                <i class="icon ion-social-rss larger"></i>
            </a>
        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    Docker 1.12的黑魔法

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Sat Jul 30 2016 00:00:00 UTC">Jul 30, 2016</div>
                    <div class="reading-time"><div class="middot"></div>2 minutes read</div>
                </div>
            </div>
            <div class="markdown">
                

<p>今年2016 Docker Conf 發表後<br />
引起大家狂熱的討論，整個會場都高潮了~XD</p>

<p>[引用一下相關的結論文章]<br />
<strong>DockerCon 2016會議：發布內容的總結及主要收穫</strong>
原文網址：<a href="https://kknews.cc/tech/mmx4yp.html">https://kknews.cc/tech/mmx4yp.html</a></p>

<p><strong>Docker Swarm 已死！Docker Swarm 萬歲！</strong>
原文網址：<a href="https://kknews.cc/tech/8e2egq.html">https://kknews.cc/tech/8e2egq.html</a></p>

<h4 id="官方無敵威的展示影片">官方無敵威的展示影片</h4>

<p><a href="https://www.youtube.com/watch?v=F7hoq0KwHD4"><img src="https://img.youtube.com/vi/F7hoq0KwHD4/0.jpg" alt="Alt text" /></a><br />
看完影片後，安迪兒超期待新版Docker1.12的發表<br />
等到了rc2，就迫不急待的試玩一下<br />
因為安迪兒想把舊式的swarm換成新的docker swarm<br />
就這樣一路從Docker1.12 rc2 rc3 rc4都玩了一遍<br />
(因為不少問題和bug，所以才會一直試到rc4 &hellip;orz)</p>

<p>終於今天Docker v1.12.0正式定版<br />
Docker大大們開發的能量超強大<br />
每一版都更新很快，也修了一大堆東西~XD<br />
<a href="https://github.com/docker/docker/releases">https://github.com/docker/docker/releases</a></p>

<p>既然Docker v1.12定版了<br />
安迪兒也馬上全新安裝<br />
順便記錄一下和分享試用Docker 1.12的心得</p>

<h4 id="這次的docker增加不少新功能">[這次的docker增加不少新功能]</h4>

<h4 id="swarm">Swarm</h4>

<p>安迪兒其實是為了這個功能<br />
才會一直的在try
因為舊版的Swarm其實有點麻煩<br />
要建置Consul Key Store daemon<br />
要建overlay的網路<br />
還要再自已寫一堆腳本去監控和偵測狀態和處理的方式</p>

<p>而新版的docker 1.12整合了Swarm<br />
也有了新的swarm cluster使用和管理方式<br />
大大的簡化了整個的流程</p>

<h4 id="新的功能">新的功能:</h4>

<h4 id="docker-service-stack-cloud">Docker Service、Stack、Cloud</h4>

<p>整合stack與service的管理，可以使用deploy把stack部署到cloud上</p>

<h4 id="health-check">Health check</h4>

<p><a href="https://github.com/docker/docker/pull/23218">https://github.com/docker/docker/pull/23218</a><br />
可以自訂節點的健康<br />
&ndash;health-cmd (health用的指令檔)<br />
&ndash;health-interval (health的秒數)<br />
然後用一般的docker inspect就可以查詢check的結果</p>

<pre><code>docker inspect --format='' xxname healthy
</code></pre>

<h4 id="live-restore">Live restore</h4>

<p><a href="https://github.com/docker/docker/pull/23213">https://github.com/docker/docker/pull/23213</a><br />
啟動時增加這個參數，daemon掛了也不會影響到container
&ndash;live-restore</p>

<h4 id="overlay2">overlay2</h4>

<p><a href="https://github.com/docker/docker/pull/22126">https://github.com/docker/docker/pull/22126</a><br />
裡面有benchmark的數據可以參考一下</p>

<p>其它還有很多細的東西、指令、參數之類<br />
有興趣的，可以多查查官方的說明<br />
看了這些，應該手癢了吧</p>

<p>[實作時間到嘍!]</p>

<h4 id="1-安裝新版docker-for-1-12">1. 安裝新版docker for 1.12</h4>

<p>參考這頁的說明<br />
<a href="https://github.com/docker/docker/releases">https://github.com/docker/docker/releases</a></p>

<p>執行安裝指令</p>

<pre><code>curl -fsSL https://experimental.docker.com/ | sh
</code></pre>

<pre><code>sudo usermod -aG docker andy
</code></pre>

<p><img src="https://goo.gl/EMIf5a" width="100%"><br />
<img src="https://goo.gl/zogzGo" width="100%"></p>

<h4 id="2-玩玩container的叢集-建一個swarm來玩玩吧">2. 玩玩Container的叢集，建一個swarm來玩玩吧</h4>

<p>首先在master機器上，建立管理的節點</p>

<pre><code>docker swarm init --listen-addr docker112-swarm-admin:2377
</code></pre>

<p><img src="https://goo.gl/ymP7Z4" width="100%"></p>

<p>再來，在其它台node機器上輸入</p>

<pre><code>docker swarm join \
 --token SWMTKN-1-55xrvnhhax0eqc0hi4iu6aihh8msqvlfjdgqetaqvlf8qm4n0z-7ekdghz9an5d4jpx4ibdaigtx \
 10.240.0.3:2377
</code></pre>

<p><img src="https://goo.gl/CjM4D4" width="100%"><br />
都加入叢集後，可以在主節點master那台，查一下所有的node</p>

<pre><code>docker node ls
</code></pre>

<p><img src="https://goo.gl/hPGhT6" width="100%"></p>

<p>看看，超神奇的，就這樣一個跨機器的Container cluster就立完成了<br />
這是不是docker的 <strong>黑魔法</strong> 吶~~~太可怕了，合併swarm後簡化許多繁雜的東西</p>

<h4 id="3-新增自已用的network">3. 新增自已用的network</h4>

<p>用docker network 建立一個自已的overlay來玩玩<br />
建完並指定Container的overlay後，Container就能視為同網段，跨各種機器運行了</p>

<pre><code>docker network create --driver overlay bowwow-net  
</code></pre>

<p><img src="https://goo.gl/xY51ig" width="100%"></p>

<h4 id="4-來見識一下讓大家瘋狂的docker-service威力吧">4. 來見識一下讓大家瘋狂的Docker Service威力吧</h4>

<p>建個postgresql database，直接replicas 2台<br />
2台都是同樣的database</p>

<pre><code>docker service create --replicas 2 -p 5432:5432 -p 8000:5432 --name=postgresql --network=bowwow-net --env=&quot;constraint:node==docker-swarm-node1&quot; --mount type=volume,source=/home/app/metadb,target=/var/lib/postgresql -e POSTGRESQL_USER=postgres -e POSTGRESQL_PASS=1234 -e POSTGRESQL_DB=demodb bowwow/posttgresql9.4
</code></pre>

<pre><code>docker service ls
</code></pre>

<p><img src="https://goo.gl/Vb5Xax" width="100%"></p>

<p>可以看到postgresql啟動完成，2台分散在不同的機器上</p>

<p>直接來玩一下，2台機器的postgresql同時都能連上<br />
<img src="https://goo.gl/6W7Eox" width="100%"></p>

<p>隨便改一下其中一台，建一個新的table<br />
<img src="https://goo.gl/6W7Eox" width="100%"></p>

<p>過一會另一台就跟都同步了<br />
<img src="https://goo.gl/gWsS1S" width="100%"><br />
而且因為用了bowwow-net的關係<br />
開三台機器，三台機器都能互相找的到<br />
也就是說，連上3台機器的ip，都能接上這個postgresql db<br />
但這個postgresql db是分散成2個Container在跑<br />
<strong>docker都幫你做了ha、scale和cluster了</strong><br />
<strong>只能說:超~<del>神</del>~的!!!</strong></p>

<h5 id="隨興的新增和刪除container節點">隨興的新增和刪除Container節點</h5>

<pre><code>docker service ps postgresql
docker service scale postgresql=3
docker service scale postgresql=1
docker service update --replicas 2 postgresql
</code></pre>

<h5 id="新版docker有rolling-update服務">新版docker有rolling update服務</h5>

<p><strong>&ndash;update-delay</strong></p>

<p>他會慢慢的更版，不會一次都換掉<br />
ex:</p>

<pre><code>docker service create \
  --replicas 3 \
  --name redis \
  --update-delay 10s \
  redis:3.0.6
</code></pre>

<h5 id="試一下swarm-container-cluster移轉的功能">試一下Swarm Container Cluster移轉的功能</h5>

<p>惡意關掉刪除其中一台的postgresql Container<br />
<img src="https://goo.gl/xVWrW9" width="100%"><br />
<img src="https://goo.gl/EiFWMM" width="100%"></p>

<p><strong>果然夠優~馬上又自動的在別台機器上重啟了一個相同的服務</strong></p>

<p>一次開10個來玩玩吧<br />
<img src="https://goo.gl/fDCI28" width="100%"></p>

<p>不想要服務了，刪除它</p>

<pre><code>docker service rm postgresql
docker service ls
</code></pre>

<p><img src="https://goo.gl/pYzbDR" width="100%"></p>

<p>新的Docker以上這些功能<br />
跟本就是有k8s(Kubernetes)的影子<br />
連相關指令名稱都有點相近<br />
難怪大家整個看到傻眼，進化後的Docker太強大了。</p>

<h4 id="5-部署docker-stack">5. 部署Docker Stack</h4>

<p>大致上看起來<br />
新的docker swarm像是用service就可以處理&amp;管理相關的container服務<br />
如果想用之前compose之類的一次啟動管理的方式呢??
安迪兒找了找，發現docker有一個deploy的相關功能<br />
看了他文字上有說，要用dab來部署<br />
忍不住好奇試了一下<br />
真的是可以用</p>

<p>首先，先裝上最新版的docker-compose(1.8)<br />
參考這頁<br />
<a href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a></p>

<pre><code>curl -L https://github.com/docker/compose/releases/download/1.8.0/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose  
</code></pre>

<p><img src="https://goo.gl/6dB7jy" width="100%"></p>

<p>編寫一下docker-compose file<br />
啟動它，成功後，可以再自行下指令bundle成dab檔<br />
再使用docker deploy去部署</p>

<pre><code>sudo docker-compose up -d
sudo docker-compose bundle -o elk.dab
docker deploy elk
</code></pre>

<p><img src="https://goo.gl/Jfuq9q" width="100%"><br />
<img src="https://goo.gl/FlZqKI" width="100%"><br />
<img src="https://goo.gl/mqRVTu" width="100%"></p>

<p>看一下結果吧<br />
<img src="https://goo.gl/Cr71Mu" width="100%"><br />
<img src="https://goo.gl/QERLf3" width="100%"></p>

<p>呼&hellip;終於，東西實在太多了，安迪就也沒辦法一次說完試完<br />
總之，這次的docker 1.12非常的強大<br />
如果想要有較簡易的，除了k8s或mesos另外選擇的<br />
也許考慮一下原生的docker看看嘍<br />
應該不會失望的~~~XD<br />
收工嘍~收工嘍!</p>

                <br>
                <p><a href="post">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'bowwowtips';
    var disqus_identifier = '\/127.0.0.1\/post\/20160730\/';
    var disqus_title = 'Docker 1.12的黑魔法';
    var disqus_url = '\/127.0.0.1\/post\/20160730\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
            <br>
            <div class="ga">
            
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-78436139-1', 'auto');
ga('send', 'pageview');
</script>

            </div>
        </div>
    </div>
</section>


  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
  

  <script type="text/javascript">
    hljs.initHighlightingOnLoad();
  </script>



</body>
</html>

